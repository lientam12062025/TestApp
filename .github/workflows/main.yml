name: Auto Build 3.2

on:
  workflow_dispatch:
    inputs:
      ROM_URL:
        description: 'OTA URL for ROM'
        required: true
        type: string

jobs:
  Build:
    runs-on: ubuntu-latest
    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          swap-size-mb: 8192
          root-reserve-mb: 2048    # Giáº£m cÃ¡i nÃ y xuá»‘ng 2048 (2GB) lÃ  Ä‘á»§ cho OS cháº¡y
          temp-reserve-mb: 1024    # QUAN TRá»ŒNG: Giáº£m cÃ¡i nÃ y xuá»‘ng 1024 hoáº·c tháº¥p hÆ¡n
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          overprovision-lvm: 'true'

      - name: Checkout Runner Repo
        uses: actions/checkout@v4

      # BÆ°á»›c 2: Xá»­ lÃ½ logic chá»n nhÃ¡nh (Viáº¿t gá»n hÆ¡n)
      - name: Determine branch
        id: pick_branch
        run: |
          if [[ "${{ inputs.ROM_URL }}" == *[Gg]lobal* ]]; then
            echo "branch=3.2G" >> $GITHUB_OUTPUT
            echo "Target: Global (3.2G)"
          else
            echo "branch=3.2" >> $GITHUB_OUTPUT
            echo "Target: China/Them (3.2)"
          fi

      # BÆ°á»›c 3: Checkout code Private tá»« tÃ i khoáº£n chÃ­nh (An toÃ n hÆ¡n git clone tay)
      - name: Checkout HyperTN_Code
        uses: actions/checkout@v4
        with:
          repository: thangnguyen2303/HyperTN_Code
          ref: ${{ steps.pick_branch.outputs.branch }}
          token: ${{ secrets.TNKEY }} # Token nÃ y an toÃ n hÆ¡n khi dÃ¹ng qua action
          path: HyperTN_Code
            
      - name: Set up environment
        run: |
          sudo timedatectl set-timezone Asia/Ho_Chi_Minh
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            xmlstarlet bc aria2 python3 p7zip-full zipalign \
            android-sdk-libsparse-utils lz4 xz-utils zlib1g-dev \
            openjdk-17-jdk gcc g++ python-is-python3
          sudo pip3 install pycryptodome
          curl -s https://rclone.org/install.sh | sudo bash
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE }}" | base64 -d > ~/.config/rclone/rclone.conf

      - name: Run Auto Build TN
        run: |
          cd HyperTN_Code
          sudo chmod -R +x .
          echo "${{ inputs.ROM_URL }}"
          sudo bash BuildTN.sh "${{ inputs.ROM_URL }}"
          
      - name: ðŸ”„ Checkout Website Repo
        uses: actions/checkout@v4
        with:
          # âš ï¸ Sá»¬A TÃŠN KHO WEBSITE Cá»¦A Báº N á»ž ÄÃ‚Y
          repository: thangnguyen2303/hypertn-site
          # âš ï¸ Token quyá»n ghi (Táº¡o trong Developer Settings > Personal access tokens)
          token: ${{ secrets.TNWEB }} 
          path: website-repo

      - name: ðŸ“ Update roms.json & Push
        run: |
          echo "Dang quet file tu Drive..."
          rclone listremotes
          # 1. QuÃ©t danh sÃ¡ch file tá»« Drive vÃ  ghi Ä‘Ã¨ vÃ o file roms.json cá»§a web
          # (Rclone Ä‘Ã£ Ä‘Æ°á»£c cÃ i vÃ  config á»Ÿ bÆ°á»›c 'Set up environment' nÃªn dÃ¹ng Ä‘Æ°á»£c luÃ´n)
          rclone lsjson "gdrive3:/TN/ROM" -R --files-only --no-mimetype --no-modtime --include "*.7z" > website-repo/src/data/roms1.json
          rclone lsjson "gdrive03:/TN/ROM" -R --files-only --no-mimetype --no-modtime --include "*.7z" > website-repo/src/data/roms2.json

          # 2. Commit vÃ  Ä‘áº©y code lÃªn Github
          cd website-repo
          git config --global user.name "Thang Nguyen"
          git config --global user.email "nvthang2303@outlook.com.vn"

          # Kiá»ƒm tra xem cÃ³ gÃ¬ thay Ä‘á»•i khÃ´ng
          if [[ -n $(git status -s) ]]; then
            git add src/data/*.json
            git commit -m "ðŸ¤– Auto-update ROM List: $(date '+%Y-%m-%d %H:%M')"
            git push
            echo "âœ… Da cap nhat Website thanh cong!"
          else
            echo "ðŸ’¤ Khong co file ROM moi, bo qua update web."
          fi

